name: Publish to PyPI

on: workflow_dispatch

jobs:

  build-and-publish:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.7", "3.8", "3.9", "3.10", "3.11"]
        version: "1.2.3"

    steps:
    - name: Check out the Repository
      uses: actions/checkout@v3
    
    - name: Set up Python Environment
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel requests twine

    - name: Build
      run: |
        python setup.py sdist bdist_wheel

    - name: Rename file
      run: |
        mv dist/*.whl dist/OpenFrpLib-${{ matrix.version }}-py${{ matrix.python-version }}-none-any.whl
  
    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: Python${{ matrix.python-version }}-OpenFrpLib${{ matrix.version }}
        path: dist/
  
    - name: Publish
      run: |
        twine upload dist/*.whl

    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: ./ChangeLog.md
        prerelease: false
        draft: false
        tag_name: v${{ matrix.version }}
        files: |
          dist/*.whl
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}